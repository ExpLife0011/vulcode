From b99b6b6672ff2419f05b05740c80c7a23c1da994 Mon Sep 17 00:00:00 2001
From: Madhura Jayaratne <madhura.cj@gmail.com>
Date: Thu, 20 Nov 2014 06:24:34 +0530
Subject: [PATCH] bug #4595 [security] Path traversal can lead to leakage of
 line count

Signed-off-by: Madhura Jayaratne <madhura.cj@gmail.com>
---
 ChangeLog                      |  1 +
 libraries/error_report.lib.php | 13 +++++++++++++
 2 files changed, 14 insertions(+)

diff --git a/ChangeLog b/ChangeLog
index f5b06e6370c..29831777c06 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -14,6 +14,7 @@ phpMyAdmin - ChangeLog
 - bug #4602 Exporting selected rows exports all rows of the query
 - bug #4444 No insert statement produced in SQL export for queries with alias
 - bug #4596 [security] XSS through exception stack
+- bug #4595 [security] Path traversal can lead to leakage of line count
 
 4.2.11.0 (2014-10-31)
 - bug       ReferenceError: Table_onover is not defined
diff --git a/libraries/error_report.lib.php b/libraries/error_report.lib.php
index 8843dfcd31a..1bc73ef945d 100644
--- a/libraries/error_report.lib.php
+++ b/libraries/error_report.lib.php
@@ -177,6 +177,19 @@ function PMA_countLines($filename)
         return $LINE_COUNT[$filename];
     }
 
+    // ensure that the file is inside the phpMyAdmin folder
+    $depath = 1;
+    foreach (explode('/', $filename) as $part) {
+        if ($part == '..') {
+            $depath--;
+        } elseif ($part != '.') {
+            $depath++;
+        }
+        if ($depath < 0) {
+            return 0;
+        }
+    }
+
     $linecount = 0;
     $handle = fopen('./js/' . $filename, 'r');
     while (!feof($handle)) {
