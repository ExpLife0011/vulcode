From 016ec99d25b1cb83cb4367e541177aa431beb600 Mon Sep 17 00:00:00 2001
From: Michael Scherer <misc@zarb.org>
Date: Sun, 13 Apr 2014 12:20:17 +0200
Subject: [PATCH] Use non-predictable filename for downloaded patch file

Since the /tmp directory is readable by everybody on Unix, and since
the patch name could be public or easy to guess, a attacker could create a symlink
to a file writable by the user running hub, which would be replaced by the patch.

This has been assigned CVE-2014-0177
---
 lib/hub/commands.rb | 2 +-
 lib/hub/context.rb  | 4 ----
 2 files changed, 1 insertion(+), 5 deletions(-)

diff --git a/lib/hub/commands.rb b/lib/hub/commands.rb
index f24e6f36..4b555291 100644
--- a/lib/hub/commands.rb
+++ b/lib/hub/commands.rb
@@ -519,7 +519,7 @@ def am(args)
           end
         end
 
-        patch_file = File.join(tmp_dir, patch_name)
+        patch_file = Tempfile.new('patch_name')
         File.open(patch_file, 'w') { |file| file.write(patch) }
         args[idx] = patch_file
       end
diff --git a/lib/hub/context.rb b/lib/hub/context.rb
index a41fcbbc..46c4c415 100644
--- a/lib/hub/context.rb
+++ b/lib/hub/context.rb
@@ -556,10 +556,6 @@ def command?(name)
         !which(name).nil?
       end
 
-      def tmp_dir
-        ENV['TMPDIR'] || ENV['TEMP'] || '/tmp'
-      end
-
       def terminal_width
         if unix?
           width = %x{stty size 2>#{NULL}}.split[1].to_i
