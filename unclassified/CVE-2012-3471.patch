From 3f14fa0d09ac7e6ad69f5fa1443a7ea4df327381 Mon Sep 17 00:00:00 2001
From: Robbie Mackay <rm@robbiemackay.com>
Date: Mon, 2 Jul 2012 08:47:10 +1200
Subject: [PATCH] Fix SQLi in admin and members reports/edit controllers #645

* Previously the incident id was not sanitized before being used in
  the geometry query.
---
 application/controllers/admin/reports.php   | 4 ++--
 application/controllers/members/reports.php | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/application/controllers/admin/reports.php b/application/controllers/admin/reports.php
index 42e9cf871..4f81d5408 100755
--- a/application/controllers/admin/reports.php
+++ b/application/controllers/admin/reports.php
@@ -707,8 +707,8 @@ public function edit($id = FALSE, $saved = FALSE)
 					$sql = "SELECT AsText(geometry) as geometry, geometry_label,
 						geometry_comment, geometry_color, geometry_strokewidth
 						FROM ".Kohana::config('database.default.table_prefix')."geometry
-						WHERE incident_id=".$id;
-					$query = $db->query($sql);
+						WHERE incident_id = ?";
+					$query = $db->query($sql, $id);
 					foreach ( $query as $item )
 					{
 						$geometry = array(
diff --git a/application/controllers/members/reports.php b/application/controllers/members/reports.php
index 77fdefde8..c1a6a4ef6 100644
--- a/application/controllers/members/reports.php
+++ b/application/controllers/members/reports.php
@@ -496,8 +496,8 @@ public function edit($id = FALSE, $saved = FALSE)
 					$sql = "SELECT AsText(geometry) as geometry, geometry_label, 
 						geometry_comment, geometry_color, geometry_strokewidth 
 						FROM ".Kohana::config('database.default.table_prefix')."geometry 
-						WHERE incident_id=".$id;
-					$query = $db->query($sql);
+						WHERE incident_id = ?";
+					$query = $db->query($sql, $id);
 					foreach ( $query as $item )
 					{
 						$geometry = array(
