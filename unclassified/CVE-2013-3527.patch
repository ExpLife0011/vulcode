From 83078591bc4d263e77d2a2ca283100997755290d Mon Sep 17 00:00:00 2001
From: Todd Burry <todd@vanillaforums.com>
Date: Thu, 4 Apr 2013 20:08:33 -0400
Subject: [PATCH] Disable the ability to call functions in escaped sql strings.

---
 library/database/class.sqldriver.php | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/library/database/class.sqldriver.php b/library/database/class.sqldriver.php
index 3a131b8ea8..6803584c06 100644
--- a/library/database/class.sqldriver.php
+++ b/library/database/class.sqldriver.php
@@ -309,6 +309,13 @@ public function ConditionExpr($Field, $Value, $EscapeFieldSql = TRUE, $EscapeVal
          $Field = '@' . $Field;
       }
       if(is_array($Value)) {
+         //$ValueStr = var_export($Value, TRUE);
+         $ValueStr = 'ARRAY';
+         Deprecated("Gdn_SQL->ConditionExpr(VALUE, {$ValueStr})", 'Gdn_SQL->ConditionExpr(VALUE, VALUE)');
+         
+         if ($EscapeValueSql)
+            throw new Gdn_UserException('Invalid function call.');
+         
          $FunctionCall = array_keys($Value);
          $FunctionCall = $FunctionCall[0];
          $FunctionArg = $Value[$FunctionCall];
