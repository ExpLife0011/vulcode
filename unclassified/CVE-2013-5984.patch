From 9177d134960c24cb642d5cf3b42a1fba286219cc Mon Sep 17 00:00:00 2001
From: Peter Ivanov <peter@microweber.com>
Date: Thu, 26 Sep 2013 16:19:10 +0300
Subject: [PATCH] fix of CVE HTB23175
 https://www.htbridge.com/advisory/HTB23175

---
 src/Microweber/Utils/Backup.php | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/Microweber/Utils/Backup.php b/src/Microweber/Utils/Backup.php
index 0297760be..94e52ee2f 100644
--- a/src/Microweber/Utils/Backup.php
+++ b/src/Microweber/Utils/Backup.php
@@ -1496,7 +1496,7 @@ function download($params)
         if (!is_admin()) {
             error("must be admin");
         }
-        ;
+
         ini_set('memory_limit', '512M');
         set_time_limit(0);
 
@@ -1507,6 +1507,8 @@ function download($params)
         } else if (isset($_GET['file'])) {
             $id = $params['file'];
         }
+        $id = str_replace('..', '', $id);
+
 
         // Check if the file has needed args
         if ($id == NULL) {
@@ -1519,6 +1521,7 @@ function download($params)
         // Generate filename and set error variables
 
         $filename = $here . $id;
+        $filename = str_replace('..','',$filename);
         if (!is_file($filename)) {
             return array('error' => "You have not provided a existising filename to download.");
 
@@ -1542,6 +1545,10 @@ function download($params)
 
     function readfile_chunked($filename, $retbytes = TRUE)
     {
+
+
+        $filename = str_replace('..','',$filename);
+
         $chunk_size = 1024 * 1024;
         $buffer = "";
         $cnt = 0;
@@ -1550,6 +1557,10 @@ function readfile_chunked($filename, $retbytes = TRUE)
         if ($handle === false) {
             return false;
         }
+
+
+
+
         while (!feof($handle)) {
             $buffer = fread($handle, $chunk_size);
             echo $buffer;
