From 5641588c730cc75dc3b76c34b76271fbd407fb84 Mon Sep 17 00:00:00 2001
From: Jeremy Lindop <jeremy.lindop@btconnect.com>
Date: Tue, 28 Oct 2014 10:13:06 +0000
Subject: [PATCH] BZ1158017: fix XXE vulnerability when importing a BP from a
 bpmn2 (XML) file.

---
 .../java/org/jbpm/designer/bpmn2/resource/JBPMBpmn2ResourceImpl.java | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/jbpm-designer-backend/src/main/java/org/jbpm/designer/bpmn2/resource/JBPMBpmn2ResourceImpl.java b/jbpm-designer-backend/src/main/java/org/jbpm/designer/bpmn2/resource/JBPMBpmn2ResourceImpl.java
index 578ba6d94..750b87876 100644
--- a/jbpm-designer-backend/src/main/java/org/jbpm/designer/bpmn2/resource/JBPMBpmn2ResourceImpl.java
+++ b/jbpm-designer-backend/src/main/java/org/jbpm/designer/bpmn2/resource/JBPMBpmn2ResourceImpl.java
@@ -28,6 +28,11 @@ public JBPMBpmn2ResourceImpl(URI uri) {
         this.getDefaultLoadOptions().put(XMLResource.OPTION_DISABLE_NOTIFY, true);
         this.getDefaultLoadOptions().put(XMLResource.OPTION_USE_XML_NAME_TO_FEATURE_MAP, xmlNameToFeatureMap);
 
+        // Switch off DTD external entity processing
+        Map parserFeatures = new HashMap();
+        parserFeatures.put("http://xml.org/sax/features/external-general-entities", false);
+        this.getDefaultLoadOptions().put(XMLResource.OPTION_PARSER_FEATURES, parserFeatures);
+
         this.getDefaultSaveOptions().put(XMLResource.OPTION_ENCODING, "UTF-8");
         this.getDefaultSaveOptions().put(XMLResource.OPTION_PROCESS_DANGLING_HREF, XMLResource.OPTION_PROCESS_DANGLING_HREF_DISCARD);
 	}
